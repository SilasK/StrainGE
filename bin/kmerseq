#!/usr/bin/env python
import sys
import argparse
#workaround for no X windows
import matplotlib as mp
mp.use("Agg")
import kmertools
import numpy as np



parser = argparse.ArgumentParser()
parser.add_argument('sequences', nargs='+',
                    help='Input sequence files (fasta or fastq; optionally compressed with gz or bz2)')
parser.add_argument("-k", "--K", help="Kmer size (default 23)", type=int, default=23)
parser.add_argument("-o", "--output", help="Output file (in numpy npz format)")
parser.add_argument("-f", "--fingerprint", help="Include kmer fingerprint in output file for quick matching",
                    action="store_true")
parser.add_argument("--fraction", type=float, default=0.002, help="Fraction of kmers to include in fingerprint (default: 0.002)")
parser.add_argument("-c", "--compress", help="Compress output file", action="store_true")
parser.add_argument("--npz", help="Store output in npz format (default hdf5)", action="store_true")
parser.add_argument("-F", "--filter", help="Filter output kmers based on kmer spectrum (to prune sequencing errors)",
                    action="store_true")
parser.add_argument("-s", "--spectrum", help="File to ouput kmer spectrum graph (.png best)")
parser.add_argument("--histogram", help="Histogram output file (count of kmers by frequency)")
args = parser.parse_args()

kset = kmertools.KmerSet(args.K)

for arg in args.sequences:
    print 'Kmerizing', arg
    kset.kmerizeFile(arg)

if args.histogram:
    kset.writeHistogram(args.histogram)

if args.spectrum:
    thresholds = kset.spectrumMinMax()
    if thresholds:
        kset.plotSpectrum(args.spectrum, thresholds[2])
    else:
        kset.plotSpectrum(args.spectrum)

if args.filter:
    thresholds = kset.spectrumFilter()
    if thresholds:
        print 'Keeping kmers with frequency in the range', thresholds
    kset.printStats()

if args.fingerprint:
    kset.minHash(args.fraction)

if args.output:
    print 'Writing output to', args.output
    kset.save(args.output, compress=args.compress, npz=args.npz)

