#!/usr/bin/env python

import sys
import csv
import argparse


parser = argparse.ArgumentParser()
parser.add_argument("--ani", "-a", default=0.999, type=float, help="Clustering threshold (ani)")
parser.add_argument("--fudge", "-f", default=0, type=float, help="Similarity score output file (default stdout)")
parser.add_argument("simfile", help="kmersimilarity output file")
args = parser.parse_args()

fudge = args.fudge

reader = csv.reader(open(args.simfile, 'r'), delimiter="\t")

setIndex = {}
sims = []
for line in reader:
    (strain1, strain2, sim, ani) = line
    sim = float(sim)
    ani = float(ani)
    if strain1 not in setIndex:
        setIndex[strain1] = {strain1}
    if strain2 not in setIndex:
        setIndex[strain2] = {strain2}
    if ani < args.ani:
        continue
    sims.append((strain1, strain2, ani))
    # merge sets
    set1 = setIndex[strain1]
    set2 = setIndex[strain2]
    if set1 != set2:
        set1 |= set2
        for s in set2:
            setIndex[s] = set1

def simScore(genome):
    gsims = [sim[2] for sim in sims if sim[0] == genome or sim[1] == genome]
    return sum(gsims)/float(len(gsims))
    
sets = []

def sorter(a, b):
    diff = b[1] - a[1]
    if abs(diff) <= fudge:
        return cmp(len(a[0]), len(b[0])) or cmp(a[0], b[0])
    else:
        return cmp(b[1], a[1])

for s in setIndex.values():
    if s not in sets:
        sets.append(s)
        if len(s) == 1:
            print " ".join(s)
        else:
            slist = [(g, simScore(g)) for g in s]
            slist.sort(sorter)
            #print slist
            #print
            print " ".join([g[0] for g in slist])
print >>sys.stderr, len(sets), 'sets containing', sum([len(s) for s in sets]), 'genomes'
